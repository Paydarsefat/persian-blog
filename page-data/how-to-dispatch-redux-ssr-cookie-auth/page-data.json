{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-to-dispatch-redux-ssr-cookie-auth/","result":{"data":{"site":{"siteMetadata":{"title":"احسان گازار"}},"markdownRemark":{"id":"88b55a67-c3be-547f-899a-6caf44522b42","excerpt":"این ویدئو ترکیبی از خیلی از دانش‌هایی است که در این دوره یاد گرفتیم، یعنی میخوایم در Server که در NextJs با getInitialProps هندل میشه، بیایم و یک Request…","html":"<p>این ویدئو ترکیبی از خیلی از دانش‌هایی است که در این دوره یاد گرفتیم، یعنی میخوایم در Server که در NextJs با getInitialProps هندل میشه، بیایم و یک Request به سمت سرور برای مشخص کردن وضعیت Auth برای کاربر بفرستیم.</p>\n<br />\n<p>خب شاید قسمت اول کمی واضح باشه که خب در NextJs میتونیم بیایم و در getInitialProps اطلاعات رو بگیریم</p>\n<br />\n<p>که در این مثال چون برای تمامی App میخوایم اینکار رو انجام بدیم باید این رو در فایل ‍‍<code class=\"language-text\">_app.jsx</code> بنویسیم.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">MyApp<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getInitialProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">appContext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<br />\n<p>مرحله‌ی بعد باید بدونیم که چون میخوایم اطلاعات رو سمت سرور بگیریم پس باید به نحوی آن‌را در سمت کلاینت نیز بفرستیم. راهکارهای زیادی برای این موضوع وجود دارد ولی من از Cookie در این پروژه استفاده میکنم.</p>\n<br />\n<p>پس در نتیجه لازم است در سمت سرور با Cookie کار کنم! که چون در سمت سرور Window تعریف نشده است می‌بایست از متغیر ctx استفاده کنم.</p>\n<br />\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">MyApp<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getInitialProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">appContext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> cookies <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    cookies <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookies</span><span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    cookies <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  windowHandler<span class=\"token punctuation\">.</span>cookies <span class=\"token operator\">=</span> cookies\n\n  <span class=\"token keyword\">const</span> pageProps <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> App<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialProps</span><span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>و مسئله‌ی بعدی چون من در این پروژه از Redux استفاده میکنم بهتر هم هست که باز برای صدا کردن این API بیام و از Dispatch استفاده کنم.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">MyApp<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getInitialProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">appContext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>reduxStore <span class=\"token operator\">=</span> store\n  <span class=\"token keyword\">let</span> cookies <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    cookies <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookies</span><span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    cookies <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  windowHandler<span class=\"token punctuation\">.</span>cookies <span class=\"token operator\">=</span> cookies\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cookies<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">VALIDATE_ME_ACTION</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> auth <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> auth<span class=\"token punctuation\">.</span>user\n      <span class=\"token keyword\">const</span> emailCookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">email=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>email<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n      appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>emailCookie<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> loggedCookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">logged=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>auth<span class=\"token punctuation\">.</span>logged<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n      appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>loggedCookie<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> loggedCookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">logged=false</span><span class=\"token template-punctuation string\">`</span></span>\n      appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>loggedCookie<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> emailCookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">email=</span><span class=\"token template-punctuation string\">`</span></span>\n      appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>emailCookie<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> userCookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">user=</span><span class=\"token template-punctuation string\">`</span></span>\n      appContext<span class=\"token punctuation\">.</span>ctx<span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>userCookie<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">await</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LOGOUT_ACTION</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> pageProps <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> App<span class=\"token punctuation\">.</span><span class=\"token function\">getInitialProps</span><span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>کد بالا داره نشون میده که من چطور اطلاعات رو از API با صدا کردن VALIDATE<em>ME</em>ACTION میگیرم و چطور بعدش اطلاعات دریافتی رو تحلیل میکنم و روی Cookie قرار میدهمو</p>\n<br />\n<p>این سناریو خیلی میتونه نسبت به پروژه متفاوت باشه و پیاده‌سازی های مختلفی رو ازش میتونین ببینید. اما مراحل و روش استفاده تقریبا همیشه همین هست.</p>\n<br />\n<p>جزئیات بیشتر را می‌توانید در ویدئو ببینید.</p>\n<br />\n<p>این یکی از ویدئو‌های\n<a href=\"/react-advanced-course\">آموزش آنلاین React پیشرفته</a>\nهست.</p>","fields":{"slug":"/how-to-dispatch-redux-ssr-cookie-auth/"},"frontmatter":{"title":"کار کردن با Cookie و Dispatch کردن در سمت سرور و انتقال State به کلاینت ساید","date":"September 09, 2020","description":"کار کردن با Cookie و Dispatch کردن در سمت سرور و انتقال State به کلاینت ساید","videoSourceURL":"https://www.youtube.com/embed/H7780-Gtr3g","category":"react-advanced","comment":true,"videoTitle":"کار کردن با Cookie و Dispatch کردن در سمت سرور و انتقال State به کلاینت ساید","cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAByKmyAkX/xAAXEAEBAQEAAAAAAAAAAAAAAAABADEC/9oACAEBAAEFAtudEIzIv//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAMBAQAAAAAAAAAAAAAAAAEQEQAx/9oACAEBAAY/AuQYsxf/xAAYEAADAQEAAAAAAAAAAAAAAAAAASERQf/aAAgBAQABPyG54Mg0XsEGMZ4HDQxmf//aAAwDAQACAAMAAAAQ79//xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQMBAT8QJNv/xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQIBAT8QYcv/xAAbEAEAAwEAAwAAAAAAAAAAAAABABEhQTFhcf/aAAgBAQABPxA2lA4dDXKlFoV5BUHJZps91FDeXzJiVBVnxlJ3vZ//2Q==","aspectRatio":1.7699115044247788,"src":"/static/89a0dfc85658cb2a71cd9d1b371aba2b/14b42/cover.jpg","srcSet":"/static/89a0dfc85658cb2a71cd9d1b371aba2b/f836f/cover.jpg 200w,\n/static/89a0dfc85658cb2a71cd9d1b371aba2b/2244e/cover.jpg 400w,\n/static/89a0dfc85658cb2a71cd9d1b371aba2b/14b42/cover.jpg 800w,\n/static/89a0dfc85658cb2a71cd9d1b371aba2b/47498/cover.jpg 1200w,\n/static/89a0dfc85658cb2a71cd9d1b371aba2b/0e329/cover.jpg 1600w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/how-to-dispatch-redux-ssr-cookie-auth/","previous":{"fields":{"slug":"/how-to-dispatch-api-redux-ssr-nextjs/"},"frontmatter":{"title":"صدا کردن API در SSR برای NextJS با Dispatch در Redux"}},"next":{"fields":{"slug":"/how-to-work-with-apollo-client-apollo-provider-use-query/"},"frontmatter":{"title":"کار با Apollo Client و ApolloProvider و آشنایی با هوک useQuery"}}}}}